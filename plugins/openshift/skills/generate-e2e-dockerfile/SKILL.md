---
name: Generate E2E Dockerfile
description: Generate or locate a Dockerfile for running e2e tests in a container
---

# Generate E2E Dockerfile

This skill generates a `Dockerfile.ci` for running e2e tests in a container, or locates an existing CI Dockerfile that can be used for testing.

## When to Use This Skill

Use this skill when you need to:

- Create a containerized environment for running e2e tests
- Find an existing CI Dockerfile in the repository
- Generate a generic e2e test Dockerfile when none exists
- Ensure consistent test execution across different environments

## Prerequisites

1. **Go Module**
   - The repository must have a `go.mod` file
   - Required for determining the module path

2. **E2E Tests Discovered**
   - Use the `discover-e2e-tests` skill first
   - Need to know the e2e test path

3. **Container Runtime**
   - Use the `detect-container-runtime` skill
   - Need podman or docker to build the image

## Implementation Steps

### Step 1: Check for Existing Dockerfile

Search for existing CI-related Dockerfiles:

```bash
# Priority order for existing Dockerfiles
DOCKERFILE_CANDIDATES=(
    "Dockerfile.ci"
    "Dockerfile.e2e"
    "Dockerfile.test"
    "build/Dockerfile.ci"
    "build/Dockerfile"
    "hack/Dockerfile"
)

for dockerfile in "${DOCKERFILE_CANDIDATES[@]}"; do
    if [ -f "$dockerfile" ]; then
        echo "Found existing Dockerfile: $dockerfile"
        DOCKERFILE="$dockerfile"
        break
    fi
done
```

### Step 2: Analyze Existing Dockerfile (if found)

If an existing Dockerfile is found, verify it's suitable for e2e tests:

```bash
# Check if it builds Go code
if grep -q "go build\|go test\|go mod" "$DOCKERFILE" 2>/dev/null; then
    echo "Dockerfile appears suitable for Go testing"
    DOCKERFILE_SUITABLE=true
else
    echo "Warning: Dockerfile may not be suitable for Go e2e tests"
    DOCKERFILE_SUITABLE=false
fi
```

### Step 3: Generate Dockerfile (if needed)

If no suitable Dockerfile exists, generate one:

```bash
cat > Dockerfile.ci << 'EOF'
# E2E Test Dockerfile
# Generated by openshift:run-e2e-tests-in-container

# Build stage
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

# Set working directory
WORKDIR /go/src/app

# Copy go mod files first for better caching
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Build test binary (optional, for pre-compilation)
# RUN go test -c -o /tmp/e2e.test ./TEST_PATH/...

# Runtime stage
FROM registry.ci.openshift.org/openshift/release:golang-1.22

WORKDIR /go/src/app

# Copy the source and dependencies from builder
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod

# Set environment variables
ENV KUBECONFIG=/kubeconfig/config
ENV CGO_ENABLED=0

# Default command runs e2e tests
# Override TEST_PATH with actual e2e test path
CMD ["go", "test", "-timeout", "0", "-v", "./TEST_PATH/..."]
EOF
```

### Step 4: Customize Dockerfile

Replace placeholders with actual values:

```bash
# Replace TEST_PATH with actual e2e path
sed -i "s|TEST_PATH|$E2E_PATH|g" Dockerfile.ci

# Optionally add kubeconfig argument
sed -i 's|"./'"$E2E_PATH"'/..."|"./'"$E2E_PATH"'/...", "-kubeconfig=/kubeconfig/config"|g' Dockerfile.ci
```

### Step 5: Verify Dockerfile

```bash
# Check the generated Dockerfile
echo "Generated Dockerfile.ci:"
cat Dockerfile.ci
```

## Dockerfile Templates

### Template 1: Standard Go E2E Tests

For repositories using standard `go test`:

```dockerfile
# E2E Test Dockerfile - Standard Go Testing
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

WORKDIR /go/src/app

# Copy dependency files
COPY go.mod go.sum ./
RUN go mod download

# Copy source
COPY . .

# Runtime stage
FROM registry.ci.openshift.org/openshift/release:golang-1.22

WORKDIR /go/src/app
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod

ENV KUBECONFIG=/kubeconfig/config

CMD ["go", "test", "-timeout", "0", "-v", "./test/e2e/...", "-kubeconfig=/kubeconfig/config"]
```

### Template 2: Ginkgo-based E2E Tests

For repositories using Ginkgo framework:

```dockerfile
# E2E Test Dockerfile - Ginkgo Framework
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

WORKDIR /go/src/app

# Copy dependency files
COPY go.mod go.sum ./
RUN go mod download

# Install ginkgo CLI
RUN go install github.com/onsi/ginkgo/v2/ginkgo@latest

# Copy source
COPY . .

# Runtime stage
FROM registry.ci.openshift.org/openshift/release:golang-1.22

WORKDIR /go/src/app
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod
COPY --from=builder /go/src/app/go/bin/ginkgo /usr/local/bin/ginkgo

ENV KUBECONFIG=/kubeconfig/config

# Run with ginkgo for better output formatting
CMD ["ginkgo", "-v", "--timeout=0", "./test/e2e/..."]
```

### Template 3: Operator SDK E2E Tests

For repositories using Operator SDK:

```dockerfile
# E2E Test Dockerfile - Operator SDK
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

WORKDIR /go/src/app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

FROM registry.ci.openshift.org/openshift/release:golang-1.22

WORKDIR /go/src/app
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod

ENV KUBECONFIG=/kubeconfig/config
ENV TEST_OPERATOR_NAMESPACE=default

CMD ["go", "test", "-timeout", "0", "-v", "./test/e2e/...", \
     "-kubeconfig=/kubeconfig/config", \
     "-root=/go/src/app"]
```

## Environment Variables

Common environment variables to support:

| Variable | Description | Default |
|----------|-------------|---------|
| `KUBECONFIG` | Path to kubeconfig in container | `/kubeconfig/config` |
| `TEST_OPERATOR_NAMESPACE` | Namespace for operator testing | `default` |
| `TEST_WATCH_NAMESPACE` | Namespace to watch | (same as operator namespace) |
| `CGO_ENABLED` | CGO compilation flag | `0` |

## Output Files

| File | Description |
|------|-------------|
| `Dockerfile.ci` | Generated Dockerfile for e2e tests |
| (or existing) | `Dockerfile.ci`, `Dockerfile.test`, etc. |

## Error Handling

### No go.mod Found

```
Error: No go.mod file found
Cannot generate Dockerfile without Go module information.
```

### Invalid E2E Path

```
Error: E2E path '$E2E_PATH' does not exist
Please run discover-e2e-tests skill first.
```

### Dockerfile Write Permission

```
Error: Cannot write Dockerfile.e2e
Check file permissions in the current directory.
```

## Examples

### Example 1: Generate with Discovered Path

```bash
#!/bin/bash
set -e

# Assume E2E_PATH is set from discover-e2e-tests skill
E2E_PATH="${E2E_PATH:-test/e2e}"
MODULE_PATH=$(head -1 go.mod | awk '{print $2}')
REPO_NAME=$(basename "$MODULE_PATH")

# Check for existing Dockerfile
if [ -f "Dockerfile.ci" ]; then
    echo "Using existing Dockerfile.ci"
    DOCKERFILE="Dockerfile.ci"
else
    echo "Generating Dockerfile.ci..."
    
    cat > Dockerfile.ci << EOF
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

WORKDIR /go/src/app
COPY go.mod go.sum ./
RUN go mod download
COPY . .

FROM registry.ci.openshift.org/openshift/release:golang-1.22
WORKDIR /go/src/app
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod

ENV KUBECONFIG=/kubeconfig/config
CMD ["go", "test", "-timeout", "0", "-v", "./${E2E_PATH}/...", "-kubeconfig=/kubeconfig/config"]
EOF
    
    DOCKERFILE="Dockerfile.e2e"
fi

echo "Dockerfile: $DOCKERFILE"
```

### Example 2: Build the Container

```bash
#!/bin/bash
set -e

# Detect runtime (from detect-container-runtime skill)
if command -v podman &> /dev/null; then
    CONTAINER_RUNTIME="podman"
elif command -v docker &> /dev/null; then
    CONTAINER_RUNTIME="docker"
else
    echo "Error: No container runtime found"
    exit 1
fi

# Get repo name
REPO_NAME=$(basename "$(head -1 go.mod | awk '{print $2}')")
IMAGE_NAME="${REPO_NAME}-e2e:latest"

# Build
echo "Building $IMAGE_NAME..."
$CONTAINER_RUNTIME build -t "$IMAGE_NAME" -f Dockerfile.e2e .

echo "Image built: $IMAGE_NAME"
```

### Example 3: Complete Generation Flow

```bash
#!/bin/bash
set -e

# Step 1: Get module info
if [ ! -f "go.mod" ]; then
    echo "Error: No go.mod found"
    exit 1
fi

MODULE_PATH=$(head -1 go.mod | awk '{print $2}')
REPO_NAME=$(basename "$MODULE_PATH")

# Step 2: Find e2e tests
E2E_PATH=""
for dir in test/e2e tests/e2e e2e pkg/e2e; do
    if [ -d "$dir" ] && find "$dir" -name "*_test.go" -type f | head -1 | grep -q .; then
        E2E_PATH="$dir"
        break
    fi
done

if [ -z "$E2E_PATH" ]; then
    echo "Error: No e2e tests found"
    exit 1
fi

echo "Repository: $REPO_NAME"
echo "E2E Path: $E2E_PATH"

# Step 3: Check for existing or generate
if [ -f "Dockerfile.ci" ]; then
    DOCKERFILE="Dockerfile.ci"
    echo "Using existing: $DOCKERFILE"
elif [ -f "Dockerfile.e2e" ]; then
    DOCKERFILE="Dockerfile.e2e"
    echo "Using existing: $DOCKERFILE"
else
    # Detect framework for CMD
    if grep -r "github.com/onsi/ginkgo" "$E2E_PATH" --include="*.go" -q 2>/dev/null; then
        TEST_CMD='["go", "test", "-timeout", "0", "-v", "./'$E2E_PATH'/...", "-ginkgo.v"]'
    else
        TEST_CMD='["go", "test", "-timeout", "0", "-v", "./'$E2E_PATH'/...", "-kubeconfig=/kubeconfig/config"]'
    fi
    
    cat > Dockerfile.e2e << EOF
# Generated E2E Dockerfile for $REPO_NAME
FROM registry.ci.openshift.org/openshift/release:golang-1.22 AS builder

WORKDIR /go/src/app
COPY go.mod go.sum ./
RUN go mod download
COPY . .

FROM registry.ci.openshift.org/openshift/release:golang-1.22
WORKDIR /go/src/app
COPY --from=builder /go/src/app /go/src/app
COPY --from=builder /go/pkg/mod /go/pkg/mod

ENV KUBECONFIG=/kubeconfig/config
ENV CGO_ENABLED=0

CMD $TEST_CMD
EOF
    
    DOCKERFILE="Dockerfile.e2e"
    echo "Generated: $DOCKERFILE"
fi

echo ""
echo "Ready to build with:"
echo "  podman build -t ${REPO_NAME}-e2e:latest -f $DOCKERFILE ."
```

## Integration with Other Skills

This skill depends on:

- `discover-e2e-tests` - To determine the e2e test path
- `detect-container-runtime` - To build the container

This skill is used by:

- `run-e2e-tests-in-container` command - Main e2e test execution

## Base Image Options

| Image | Use Case |
|-------|----------|
| `registry.ci.openshift.org/openshift/release:golang-1.22` | OpenShift CI, Go 1.22 |
| `registry.ci.openshift.org/openshift/release:golang-1.23` | OpenShift CI, Go 1.23 |
| `registry.ci.openshift.org/ocp/builder:rhel-9-golang-1.22-openshift-4.18` | OCP builder, Go 1.22 |
| `golang:1.22` | Official Go image (fallback) |

Choose based on:

- Repository's Go version (check go.mod)
- OpenShift version compatibility
- CI infrastructure access (OpenShift CI images require registry access)

## Notes

- The generated Dockerfile uses multi-stage builds for efficiency
- Go module cache is preserved for faster test execution
- The default CMD can be overridden at runtime
- Environment variables can be passed with `-e` flag when running
- Consider adding `.dockerignore` to exclude unnecessary files from the build context
- The `:Z` SELinux flag for volume mounts is handled by the `detect-container-runtime` skill

